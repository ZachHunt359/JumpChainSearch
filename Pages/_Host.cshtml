@page "/"
@using Microsoft.AspNetCore.Components.Web
@namespace JumpChainSearch.Pages
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <base href="~/" />
    <link rel="stylesheet" href="css/bootstrap/bootstrap.min.css" />
    <link href="css/site.css" rel="stylesheet" />
    <link href="JumpChainSearch.styles.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link rel="icon" type="image/png" href="favicon.png"/>
    <component type="typeof(HeadOutlet)" render-mode="ServerPrerendered" />
</head>
<body>
    <component type="typeof(App)" render-mode="ServerPrerendered" />
    
    <script src="js/interop.js"></script>

    <div id="blazor-error-ui">
        <environment include="Staging,Production">
            An error has occurred. This application may no longer respond until reloaded.
        </environment>
        <environment include="Development">
            An unhandled exception has occurred. See browser dev tools for details.
        </environment>
        <a href="" class="reload">Reload</a>
        <a class="dismiss">🗙</a>
    </div>

    <div id="components-reconnect-modal" class="components-reconnect-hide">
        <div class="reconnect-overlay"></div>
        <div class="reconnect-dialog">
            <div class="reconnect-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M23 4v6h-6M1 20v-6h6"/>
                    <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
                </svg>
            </div>
            <div class="reconnect-content">
                <h3 id="reconnect-title">Connecting...</h3>
                <p id="reconnect-message">Attempting to reconnect to the server</p>
                <div class="reconnect-progress">
                    <div class="reconnect-progress-bar"></div>
                </div>
                <!-- Reload button removed: page will auto-reload when reconnection is possible -->
            </div>
        </div>
    </div>

    <script src="_framework/blazor.server.js"></script>
    <script>
        // Blazor reconnection UI using default mechanism with custom display
        (function() {
            const reconnectModal = document.getElementById('components-reconnect-modal');
            const reconnectTitle = document.getElementById('reconnect-title');
            const reconnectMessage = document.getElementById('reconnect-message');
            // Reload button removed
            const progressBar = reconnectModal.querySelector('.reconnect-progress-bar');
            
            let reconnectTimerId = null;
            let attemptCount = 0;
            let checkInterval = null;
            let pollInterval = null;
            let pollAbort = null;
            
            function showReconnectUI(show) {
                console.log(`${show ? 'Showing' : 'Hiding'} reconnect UI`);
                if (show) {
                    reconnectModal.classList.remove('components-reconnect-hide');
                    reconnectModal.classList.add('components-reconnect-show');
                } else {
                    reconnectModal.classList.remove('components-reconnect-show');
                    reconnectModal.classList.add('components-reconnect-hide');
                }
            }
            
            function updateProgress(attempt) {
                const maxAttempts = 8;
                const progress = (attempt / maxAttempts) * 100;
                progressBar.style.width = progress + '%';
                console.log(`Progress: ${progress}% (${attempt}/${maxAttempts})`);
            }
            
            function startMonitoring() {
                console.log('Starting reconnection monitoring - Blazor will handle reconnection');
                if (checkInterval) {
                    clearInterval(checkInterval);
                }
                if (pollInterval) {
                    clearInterval(pollInterval);
                }
                if (pollAbort) {
                    pollAbort.abort();
                }
                attemptCount = 0;
                showReconnectUI(true);
                reconnectTitle.textContent = 'Connection Lost';
                reconnectMessage.textContent = 'Attempting to reconnect...';
                updateProgress(0);
                
                // Let Blazor handle reconnection - just update the UI
                // Don't force reload - this preserves client state
                pollInterval = setInterval(() => {
                    attemptCount++;
                    reconnectTitle.textContent = 'Reconnecting...';
                    reconnectMessage.textContent = `Attempt ${attemptCount}`;
                    updateProgress(Math.min(attemptCount, 8));
                    
                    // Only reload as last resort after many attempts (60 seconds)
                    if (attemptCount >= 20) {
                        clearInterval(pollInterval);
                        pollInterval = null;
                        reconnectTitle.textContent = 'Reconnection Failed';
                        reconnectMessage.textContent = 'Please refresh the page manually';
                        updateProgress(8);
                        // Show manual reload button instead of forcing it
                        reconnectMessage.innerHTML = 'Please <a href="javascript:location.reload()" style="color: #007bff; text-decoration: underline;">refresh the page</a>';
                    }
                }, 3000);
            }
            
            function stopMonitoring() {
                console.log('Connection restored - hiding reconnect UI');
                if (checkInterval) {
                    clearInterval(checkInterval);
                    checkInterval = null;
                }
                if (pollInterval) {
                    clearInterval(pollInterval);
                    pollInterval = null;
                }
                if (pollAbort) {
                    pollAbort.abort();
                    pollAbort = null;
                }
                if (reconnectTimerId) {
                    clearTimeout(reconnectTimerId);
                    reconnectTimerId = null;
                }
                attemptCount = 0;
                reconnectTitle.textContent = 'Connected';
                reconnectMessage.textContent = 'Connection restored successfully';
                updateProgress(8);
                
                // Hide UI after brief success message
                setTimeout(() => {
                    showReconnectUI(false);
                }, 1000);
            }
            
            // Listen to Blazor's built-in reconnection events
            Blazor.start().then(() => {
                console.log('Blazor started successfully');
                
                // Override default reconnection display to use our custom UI
                const reconnectDisplay = {
                    show: () => startMonitoring(),
                    hide: () => stopMonitoring(),
                    failed: () => {
                        reconnectTitle.textContent = 'Connection Failed';
                        reconnectMessage.innerHTML = 'Unable to reconnect. Please <a href="javascript:location.reload()" style="color: #007bff; text-decoration: underline;">refresh the page</a>';
                    },
                    rejected: () => {
                        reconnectTitle.textContent = 'Connection Rejected';
                        reconnectMessage.innerHTML = 'Server rejected connection. Please <a href="javascript:location.reload()" style="color: #007bff; text-decoration: underline;">refresh the page</a>';
                    }
                };
                
                // Set custom reconnection display
                if (Blazor.defaultReconnectionHandler) {
                    Blazor.defaultReconnectionHandler._reconnectCallback = reconnectDisplay;
                }
            });
            
            // Also listen for these legacy events as fallback
            window.addEventListener('blazor:connection-lost', startMonitoring);
            window.addEventListener('blazor:connection-restored', stopMonitoring);
            // Fallback: also start monitoring on WebSocket disconnect error
            const originalLog = console.error;
            console.error = function(...args) {
                const message = args.join(' ');
                if (message.includes('Connection disconnected') || message.includes('WebSocket closed')) {
                    startMonitoring();
                }
                originalLog.apply(console, args);
            };
            
            // Also monitor Info logs for reconnection
            window.addEventListener('load', () => {
                setTimeout(() => {
                    // Check if we can access Blazor's connection
                    if (window.Blazor && window.Blazor._internal) {
                        console.log('Blazor internal API available');
                    }
                }, 1000);
            });
            
            // Reload button removed
            
            // Page visibility monitoring
            document.addEventListener('visibilitychange', () => {
                if (document.hidden) {
                    console.log('Page hidden');
                } else {
                    console.log('Page visible - checking connection');
                }
            });
        })();
    </script>
</body>
</html>
